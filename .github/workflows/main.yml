on:
  pull_request:
    branchs:
      - main

jobs:
  changefiles:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.getchangefiles.outputs.files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v1
      - id: getchangefiles
        run: echo "::set-output name=files::$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)"
      - run: echo "ls:$(ls .github/etc), pwd:$(pwd)"

  getcid:
    runs-on: ubuntu-latest
    needs: changefiles
    outputs:
      cid: ${{ steps._getcid.outputs.cid }}
    steps:
      - uses: actions/checkout@v1
      - id: _getcid
        run: |
          chmod +x ".github/etc/getcid.sh"
          echo "::set-output name=cid::$(./.github/etc/getcid.sh ${{ needs.changefiles.outputs.files }})"
          ./.github/etc/getcid.sh "${{ needs.changefiles.outputs.files }}"

  getcidlength:
    runs-on: ubuntu-latest
    needs: getcid
    outputs:
      length: ${{ steps._getcidlength.outputs.length }}
    steps:
      - id: _getcidlength
        run: echo "::set-output name=length::$( echo ${{ needs.getcid.outputs.cid }} | awk '{print length}')"
      - run: echo "cid:${{ needs.getcid.outputs.cid }}"

  upload_sci_doc:
    name: Upload SCI doc
    runs-on: ubuntu-latest
    needs: [getcid, getcidlength]
    if: ${{ needs.getcidlength.outputs.length == 46 }}
    steps:
      - uses: crustio/ipfs-crust-action@v1.0.8
        with:
          cid: ${{ needs.getcid.outputs.cid }}
          seeds: ${{ secrets.CRUST_SEEDS }}
